<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jarvis API Tester</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="app"></div>

  <script>
    const API_BASE = 'http://localhost:8080/api';
    const USER_ID = 'test-user-123';

    let state = {
      meetings: [],
      jobs: {},
      selectedFile: null,
      uploading: false,
      selectedMeeting: null,
      activeTab: 'upload',
      uploadForm: { title: '', projectId: '', attendeeIds: '' },
      testResponse: null,
      loading: false
    };

    function setState(updates) {
      state = { ...state, ...updates };
      render();
    }

    async function loadMeetings() {
      try {
        const response = await fetch(`${API_BASE}/meetings`, {
          headers: { 'x-user-id': USER_ID }
        });
        const data = await response.json();
        setState({ meetings: data.meetings || [] });
      } catch (error) {
        console.error('Failed to load meetings:', error);
      }
    }

    async function checkJobStatus(jobId) {
      try {
        const response = await fetch(`${API_BASE}/meetings/status/${jobId}`, {
          headers: { 'x-user-id': USER_ID }
        });
        const data = await response.json();
        state.jobs[jobId] = data;
        setState({ jobs: state.jobs });
        if (data.status === 'completed') loadMeetings();
      } catch (error) {
        console.error('Failed to check status:', error);
      }
    }

    function startJobPolling() {
      setInterval(() => {
        Object.keys(state.jobs)
          .filter(id => state.jobs[id].status === 'processing')
          .forEach(checkJobStatus);
      }, 3000);
    }

    async function handleUpload() {
      if (!state.selectedFile) return;
      
      setState({ uploading: true });
      const formData = new FormData();
      formData.append('audio', state.selectedFile);
      if (state.uploadForm.title) formData.append('title', state.uploadForm.title);
      if (state.uploadForm.projectId) formData.append('projectId', state.uploadForm.projectId);
      if (state.uploadForm.attendeeIds) formData.append('attendeeIds', state.uploadForm.attendeeIds);

      try {
        const response = await fetch(`${API_BASE}/meetings/upload`, {
          method: 'POST',
          headers: { 'x-user-id': USER_ID },
          body: formData
        });
        const data = await response.json();
        
        if (data.jobId) {
          state.jobs[data.jobId] = {
            jobId: data.jobId,
            filename: data.filename,
            status: 'processing',
            progress: 0
          };
          setState({
            jobs: state.jobs,
            selectedFile: null,
            uploading: false,
            activeTab: 'processing',
            uploadForm: { title: '', projectId: '', attendeeIds: '' }
          });
        }
      } catch (error) {
        alert('Upload failed: ' + error.message);
        setState({ uploading: false });
      }
    }

    async function viewMeeting(meetingId) {
      try {
        const response = await fetch(`${API_BASE}/meetings/${meetingId}`, {
          headers: { 'x-user-id': USER_ID }
        });
        const data = await response.json();
        setState({ selectedMeeting: data.meeting, activeTab: 'view' });
      } catch (error) {
        console.error('Failed to load meeting:', error);
      }
    }

    async function deleteMeeting(meetingId) {
      if (!confirm('Delete this meeting?')) return;
      try {
        await fetch(`${API_BASE}/meetings/${meetingId}`, {
          method: 'DELETE',
          headers: { 'x-user-id': USER_ID }
        });
        loadMeetings();
        if (state.selectedMeeting?.id === meetingId) {
          setState({ selectedMeeting: null });
        }
      } catch (error) {
        console.error('Failed to delete:', error);
      }
    }

    async function testEndpoint(endpoint, method) {
      setState({ loading: true });
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          method,
          headers: { 'x-user-id': USER_ID }
        });
        const data = await response.json();
        setState({
          testResponse: {
            type: response.ok ? 'success' : 'error',
            data,
            endpoint: `${method} ${endpoint}`,
            status: response.status
          },
          loading: false
        });
      } catch (error) {
        setState({
          testResponse: {
            type: 'error',
            error: error.message,
            endpoint: `${method} ${endpoint}`
          },
          loading: false
        });
      }
    }

    function getStatusIcon(status) {
      const icons = {
        completed: '✓',
        failed: '✗',
        processing: '⟳'
      };
      const colors = {
        completed: 'text-green-400',
        failed: 'text-red-400',
        processing: 'text-blue-400 animate-spin'
      };
      return `<span class="inline-block ${colors[status] || 'text-gray-400'}">${icons[status] || '○'}</span>`;
    }

    function render() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <!-- Header -->
        <div class="bg-gray-800 border-b border-gray-700 px-6 py-4">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-blue-400">🤖 Jarvis Meeting Assistant - API Tester</h1>
            <p class="text-gray-400 text-sm mt-1">User: ${USER_ID}</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-gray-800 border-b border-gray-700">
          <div class="max-w-7xl mx-auto px-6">
            <div class="flex space-x-8 overflow-x-auto">
              ${['upload', 'processing', 'meetings', 'view', 'api-test'].map(tab => `
                <button onclick="setState({ activeTab: '${tab}' })"
                  class="py-4 px-2 border-b-2 font-medium text-sm transition-colors whitespace-nowrap ${
                    state.activeTab === tab
                      ? 'border-blue-400 text-blue-400'
                      : 'border-transparent text-gray-400 hover:text-gray-300'
                  }">
                  ${tab === 'api-test' ? 'API Test' : tab.charAt(0).toUpperCase() + tab.slice(1)}
                  ${tab === 'processing' && Object.keys(state.jobs).length > 0 ? `
                    <span class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full">
                      ${Object.values(state.jobs).filter(j => j.status === 'processing').length}
                    </span>
                  ` : ''}
                </button>
              `).join('')}
            </div>
          </div>
        </div>

        <!-- Content -->
        <div class="max-w-7xl mx-auto px-6 py-8">
          ${renderTabContent()}
        </div>
      `;

      // Attach event listeners
      attachEventListeners();
    }

    function renderTabContent() {
      switch (state.activeTab) {
        case 'upload':
          return renderUploadTab();
        case 'processing':
          return renderProcessingTab();
        case 'meetings':
          return renderMeetingsTab();
        case 'view':
          return renderViewTab();
        case 'api-test':
          return renderApiTestTab();
        default:
          return '';
      }
    }

    function renderUploadTab() {
      return `
        <div class="max-w-2xl mx-auto">
          <div class="bg-gray-800 rounded-lg p-8 border border-gray-700">
            <h2 class="text-xl font-semibold mb-6">Upload Meeting Audio</h2>
            
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-12 text-center hover:border-blue-400 transition-colors">
              <div class="text-6xl mb-4">🎤</div>
              <input type="file" accept="audio/*" id="audio-upload" class="hidden" ${state.uploading ? 'disabled' : ''} />
              <label for="audio-upload" class="cursor-pointer text-blue-400 hover:text-blue-300 font-medium">
                Choose audio file
              </label>
              <p class="text-gray-500 text-sm mt-2">Supports: m4a, mp3, wav, webm</p>
              
              ${state.selectedFile ? `
                <div class="mt-6 bg-gray-700 rounded p-4 text-left">
                  <p class="text-sm text-gray-300"><strong>File:</strong> ${state.selectedFile.name}</p>
                  <p class="text-sm text-gray-300 mt-1"><strong>Size:</strong> ${(state.selectedFile.size / (1024 * 1024)).toFixed(2)} MB</p>
                </div>
              ` : ''}
            </div>

            <div class="mt-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Meeting Title (Optional)</label>
                <input type="text" id="title-input" value="${state.uploadForm.title}"
                  placeholder="e.g., Q4 Planning Meeting"
                  class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Project ID (Optional)</label>
                <input type="text" id="projectId-input" value="${state.uploadForm.projectId}"
                  placeholder="e.g., proj-123"
                  class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Attendee IDs (Optional, JSON array)</label>
                <input type="text" id="attendeeIds-input" value="${state.uploadForm.attendeeIds}"
                  placeholder='["contact-1", "contact-2"]'
                  class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400 font-mono text-sm" />
              </div>
            </div>

            <button onclick="handleUpload()" ${!state.selectedFile || state.uploading ? 'disabled' : ''}
              class="w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium py-3 px-6 rounded-lg transition-colors">
              ${state.uploading ? '⟳ Uploading...' : '⬆ Upload & Process'}
            </button>
          </div>
        </div>
      `;
    }

    function renderProcessingTab() {
      const jobsList = Object.values(state.jobs);
      
      if (jobsList.length === 0) {
        return `
          <div class="bg-gray-800 rounded-lg p-12 text-center border border-gray-700">
            <div class="text-6xl mb-4">⏰</div>
            <p class="text-gray-400">No active jobs</p>
          </div>
        `;
      }

      return `
        <h2 class="text-xl font-semibold mb-6">Processing Jobs</h2>
        <div class="space-y-4">
          ${jobsList.map(job => `
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  <span class="text-2xl mr-3">${getStatusIcon(job.status)}</span>
                  <div>
                    <p class="font-medium">${job.filename}</p>
                    <p class="text-sm text-gray-400">Job ID: ${job.jobId}</p>
                  </div>
                </div>
                <p class="text-sm font-medium text-gray-300">${job.status.toUpperCase()}</p>
              </div>
              
              ${job.status === 'processing' ? `
                <div>
                  <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-400">Progress</span>
                    <span class="text-blue-400">${job.progress}%</span>
                  </div>
                  <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${job.progress}%"></div>
                  </div>
                </div>
              ` : ''}
              
              ${job.status === 'completed' && job.meetingId ? `
                <button onclick="viewMeeting('${job.meetingId}')" class="mt-4 text-blue-400 hover:text-blue-300 text-sm font-medium">
                  View Meeting →
                </button>
              ` : ''}
              
              ${job.status === 'failed' ? `
                <div class="mt-4 bg-red-900/20 border border-red-700 rounded p-3">
                  <p class="text-red-400 text-sm">${job.error || 'Processing failed'}</p>
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderMeetingsTab() {
      return `
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">All Meetings</h2>
          <button onclick="loadMeetings()" class="text-blue-400 hover:text-blue-300 text-sm font-medium">
            ↻ Refresh
          </button>
        </div>
        
        ${state.meetings.length === 0 ? `
          <div class="bg-gray-800 rounded-lg p-12 text-center border border-gray-700">
            <div class="text-6xl mb-4">🎤</div>
            <p class="text-gray-400">No meetings yet</p>
          </div>
        ` : `
          <div class="grid gap-4">
            ${state.meetings.map(meeting => `
              <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h3 class="font-semibold text-lg mb-2">${meeting.title || 'Untitled Meeting'}</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-400">
                      <div>
                        <p>📅 ${new Date(meeting.createdAt?.seconds * 1000 || meeting.createdAt).toLocaleString()}</p>
                        <p>⏱️ Duration: ${meeting.duration || 'Unknown'}</p>
                      </div>
                      <div>
                        <p>📄 ${meeting.originalFilename}</p>
                        <p>💾 ${meeting.fileSizeMB} MB</p>
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col space-y-2 ml-4">
                    <button onclick="viewMeeting('${meeting.id}')" class="p-2 text-blue-400 hover:bg-gray-700 rounded text-sm">
                      👁 View
                    </button>
                    <button onclick="deleteMeeting('${meeting.id}')" class="p-2 text-red-400 hover:bg-gray-700 rounded text-sm">
                      🗑 Delete
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
        
        ${state.testResponse ? `
          <div class="mt-6 bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-semibold text-lg">${state.testResponse.endpoint}</h3>
              <div class="flex items-center space-x-2">
                ${state.testResponse.status ? `
                  <span class="text-sm px-2 py-1 rounded ${state.testResponse.status < 300 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}">
                    Status: ${state.testResponse.status}
                  </span>
                ` : ''}
                <button onclick="setState({ testResponse: null })" class="text-gray-400 hover:text-gray-300 text-sm">Clear</button>
              </div>
            </div>
            <div class="rounded p-4 ${state.testResponse.type === 'success' ? 'bg-green-900/20 border border-green-700' : 'bg-red-900/20 border border-red-700'}">
              <pre class="text-sm overflow-auto max-h-96">${JSON.stringify(state.testResponse.type === 'success' ? state.testResponse.data : state.testResponse.error, null, 2)}</pre>
            </div>
          </div>
        ` : ''}
      `;
    }

    function renderViewTab() {
      if (!state.selectedMeeting) {
        return `
          <div class="bg-gray-800 rounded-lg p-12 text-center border border-gray-700">
            <p class="text-gray-400">No meeting selected</p>
            <button onclick="setState({ activeTab: 'meetings' })" class="mt-4 text-blue-400 hover:text-blue-300">
              View all meetings
            </button>
          </div>
        `;
      }

      const meeting = state.selectedMeeting;
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-start">
            <h2 class="text-2xl font-bold">${meeting.title}</h2>
            <button onclick="setState({ activeTab: 'meetings' })" class="text-gray-400 hover:text-gray-300">
              ← Back
            </button>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-3 text-blue-400">Summary</h3>
            <p class="text-gray-300 whitespace-pre-wrap">${meeting.summary}</p>
          </div>

          ${meeting.keyPoints && meeting.keyPoints.length > 0 ? `
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
              <h3 class="font-semibold text-lg mb-3 text-green-400">Key Points</h3>
              <ul class="list-disc list-inside space-y-2 text-gray-300">
                ${meeting.keyPoints.map(point => `<li>${point}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          ${meeting.actionItems && meeting.actionItems.length > 0 ? `
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
              <h3 class="font-semibold text-lg mb-3 text-yellow-400">Action Items</h3>
              <div class="space-y-3">
                ${meeting.actionItems.map(item => `
                  <div class="bg-gray-700 rounded p-4">
                    <p class="font-medium text-gray-200">${item.task}</p>
                    ${item.assignee ? `<p class="text-sm text-gray-400 mt-1">Assigned to: ${item.assignee}</p>` : ''}
                    ${item.dueDate ? `<p class="text-sm text-gray-400">Due: ${item.dueDate}</p>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-3 text-purple-400">Full Transcript</h3>
            <div class="max-h-96 overflow-y-auto bg-gray-900 rounded p-4">
              <p class="text-gray-300 whitespace-pre-wrap text-sm">${meeting.transcript}</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderApiTestTab() {
      return `
        <div class="space-y-6">
          <h2 class="text-xl font-semibold mb-4">API Endpoint Tester</h2>
          
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-2 text-blue-400">GET /meetings</h3>
            <p class="text-sm text-gray-400 mb-4">Get all meetings for the user</p>
            <button onclick="testEndpoint('/meetings', 'GET')" ${state.loading ? 'disabled' : ''}
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white px-6 py-2 rounded">
              ➤ Test
            </button>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-2 text-green-400">GET /meetings/:id</h3>
            <p class="text-sm text-gray-400 mb-4">Get details of a specific meeting</p>
            <div class="flex space-x-2">
              <input type="text" placeholder="Enter meeting ID" id="get-meeting-id"
                class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400" />
              <button onclick="testEndpointWithId('get-meeting-id', '/meetings/', 'GET')" ${state.loading ? 'disabled' : ''}
                class="bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white px-6 py-2 rounded">
                ➤ Test
              </button>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-2 text-purple-400">GET /meetings/status/:jobId</h3>
            <p class="text-sm text-gray-400 mb-4">Check processing job status</p>
            <div class="flex space-x-2">
              <input type="text" placeholder="Enter job ID" id="status-job-id"
                class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400" />
              <button onclick="testEndpointWithId('status-job-id', '/meetings/status/', 'GET')" ${state.loading ? 'disabled' : ''}
                class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700 text-white px-6 py-2 rounded">
                ➤ Test
              </button>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="font-semibold text-lg mb-2 text-red-400">DELETE /meetings/:id</h3>
            <p class="text-sm text-gray-400 mb-4">Delete a meeting</p>
            <div class="flex space-x-2">
              <input type="text" placeholder="Enter meeting ID" id="delete-meeting-id"
                class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400" />
              <button onclick="testEndpointWithId('delete-meeting-id', '/meetings/', 'DELETE')" ${state.loading ? 'disabled' : ''}
                class="bg-red-600 hover:bg-red-700 disabled:bg-gray-700 text-white px-6 py-2 rounded">
                ➤ Test
              </button>
            </div>
          </div>

          ${state.testResponse ? `
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">${state.testResponse.endpoint}</h3>
                <div class="flex items-center space-x-2">
                  ${state.testResponse.status ? `
                    <span class="text-sm px-2 py-1 rounded ${state.testResponse.status < 300 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}">
                      Status: ${state.testResponse.status}
                    </span>
                  ` : ''}
                  <button onclick="setState({ testResponse: null })" class="text-gray-400 hover:text-gray-300 text-sm">Clear</button>
                </div>
              </div>
              <div class="rounded p-4 ${state.testResponse.type === 'success' ? 'bg-green-900/20 border border-green-700' : 'bg-red-900/20 border border-red-700'}">
                <pre class="text-sm overflow-auto max-h-96">${JSON.stringify(state.testResponse.type === 'success' ? state.testResponse.data : state.testResponse.error, null, 2)}</pre>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function testEndpointWithId(inputId, prefix, method) {
      const id = document.getElementById(inputId).value;
      if (!id) {
        alert('Please enter an ID');
        return;
      }
      testEndpoint(prefix + id, method);
    }

    function attachEventListeners() {
      const fileInput = document.getElementById('audio-upload');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) setState({ selectedFile: file });
        });
      }

      const titleInput = document.getElementById('title-input');
      if (titleInput) {
        titleInput.addEventListener('input', (e) => {
          state.uploadForm.title = e.target.value;
        });
      }

      const projectIdInput = document.getElementById('projectId-input');
      if (projectIdInput) {
        projectIdInput.addEventListener('input', (e) => {
          state.uploadForm.projectId = e.target.value;
        });
      }

      const attendeeIdsInput = document.getElementById('attendeeIds-input');
      if (attendeeIdsInput) {
        attendeeIdsInput.addEventListener('input', (e) => {
          state.uploadForm.attendeeIds = e.target.value;
        });
      }
    }

    // Initialize
    loadMeetings();
    startJobPolling();
    render();
  </script>
</body>
</html>